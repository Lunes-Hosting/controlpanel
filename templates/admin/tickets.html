<!DOCTYPE html>
<html>
<head>
    <title>Admin Tickets - Lunes Hosting</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='images/Luneslogo.png') }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/admin_tickets.css') }}">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6122367965027230"
    crossorigin="anonymous"></script>
</head>
<body>
    {% include 'taskbar.html' %}

    <h1 class="title">Support Tickets</h1>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="flash-messages">
                {% for message in messages %}
                    <div class="flash-message">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="filter-controls">
        <a href="{{ url_for('admin.admin_tickets_index', filter='open') }}">
            <button class="filter-button {% if filter == 'open' %}active{% endif %}">Open Tickets</button>
        </a>
        <a href="{{ url_for('admin.admin_tickets_index', filter='all') }}">
            <button class="filter-button {% if filter == 'all' %}active{% endif %}">All Tickets</button>
        </a>
    </div>

    <div class="tickets-container" id="tickets-container">
        <div id="loading" style="display:none;">Updating...</div>
        <div id="tickets-list">
            {% if tickets %}
                {% for ticket in tickets %}
                    <a href="{{ url_for('tickets.ticket', ticket_id=ticket[0]) }}" class="ticket-link">
                        <div class="ticket-card">
                            <div class="ticket-header">
                                <div class="ticket-id">#{{ ticket[0] }}</div>
                                <div class="ticket-status status-{{ ticket[3]|lower }}">{{ ticket[3]|upper }}</div>
                            </div>
                            <div class="ticket-content">
                                <h3 class="ticket-title">{{ ticket[2] }}</h3>
                                <div class="ticket-reply-status">
                                    Reply status: <span class="reply-{{ ticket[5]|lower }}">{{ ticket[5]|capitalize }}</span>
                                </div>
                            </div>
                            <div class="ticket-footer">
                                <div class="ticket-user">
                                    <span class="user-icon">ðŸ‘¤</span> User ID: {{ ticket[1] }}
                                </div>
                                <div class="ticket-date">
                                    <span class="date-icon">ðŸ•’</span> 
                                    <span {% if ticket[7] %}class="old-ticket"{% endif %}>{{ ticket[4] }}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                {% endfor %}
            {% else %}
                <div class="no-tickets">
                    <p>No tickets found.</p>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        let eventSource = null;
        let currentFilter = '{{ filter }}';

        function startUpdates() {
            if (eventSource) eventSource.close();
            
            eventSource = new EventSource(`/admin/tickets/api/updates?filter=${currentFilter}`);
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.tickets) {
                    updateTickets(data.tickets);
                }
            };
            
            eventSource.onerror = function() {
                setTimeout(startUpdates, 5000);
            };
        }

        function updateTickets(tickets) {
            const container = document.getElementById('tickets-list');
            if (!container) return;

            if (tickets.length === 0) {
                container.innerHTML = '<div class="no-tickets"><p>No tickets found.</p></div>';
                return;
            }

            let html = '';
            tickets.forEach(ticket => {
                const date = ticket.created_at ? new Date(ticket.created_at).toLocaleString() : 'Unknown';
                const oldClass = ticket.is_old ? 'old-ticket' : '';
                
                html += `
                    <a href="/tickets/${ticket.id}" class="ticket-link">
                        <div class="ticket-card">
                            <div class="ticket-header">
                                <div class="ticket-id">#${ticket.id}</div>
                                <div class="ticket-status status-${ticket.status.toLowerCase()}">${ticket.status.toUpperCase()}</div>
                            </div>
                            <div class="ticket-content">
                                <h3 class="ticket-title">${ticket.title}</h3>
                                <div class="ticket-reply-status">
                                    Reply status: <span class="reply-${ticket.reply_status.toLowerCase()}">${ticket.reply_status.charAt(0).toUpperCase() + ticket.reply_status.slice(1)}</span>
                                </div>
                            </div>
                            <div class="ticket-footer">
                                <div class="ticket-user">
                                    <span class="user-icon">ðŸ‘¤</span> User ID: ${ticket.user_id}
                                </div>
                                <div class="ticket-date">
                                    <span class="date-icon">ðŸ•’</span> 
                                    <span class="${oldClass}">${date}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `;
            });
            
            container.innerHTML = html;
        }

        document.querySelectorAll('.filter-button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                currentFilter = this.textContent.includes('All') ? 'all' : 'open';
                startUpdates();
            });
        });

        document.addEventListener('DOMContentLoaded', startUpdates);
        window.addEventListener('beforeunload', () => {
            if (eventSource) eventSource.close();
        });
    </script>
</body>
</html>